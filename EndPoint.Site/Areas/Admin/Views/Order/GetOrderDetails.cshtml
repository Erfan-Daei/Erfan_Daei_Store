@using Practice_Store.Application.Services.Orders.Queries.GetOrderDetails_Admin
@using Practice_Store.Domain.Entities.Orders
@model GetOrderDetails_AdminDto
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers;
@{
    ViewData["Title"] = "GetOrderDetails";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
}

<div class="container-fluid">
    <div class="row page-titles">
        <ol class="breadcrumb">
            <li class="breadcrumb-item active"><a href="javascript:void(0)">مدیریت سفارشات</a></li>
            <li class="breadcrumb-item"><a href="javascript:void(0)">جزئیات سفارش</a></li>
        </ol>
    </div>
    <div class="row">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-xl-9 col-lg-6 col-md-6 col-xxl-7 col-sm-12">
                            <div class="product-detail-content">
                                <div class="new-arrival-content pr">
                                    <h4>سفارش شماره @Model.RefId</h4>
                                    <div class="d-table mb-2"><p class="price float-start d-block">@((Model.TotalSum + Model.Shipping).ToString("n0"))</p></div>
                                    <p>نام و نام خانوادگی گیرنده : <span class="item">@Model.Name @Model.LastName</span></p>
                                    <p>آدرس گیرنده : <span class="item">@Model.Address</span></p>
                                    <p>کدپستی گیرنده : <span class="item">@Model.PostCode</span></p>
                                    <p>تلفن گیرنده : <span class="item">@Model.Mobile</span></p>
                                    <p>آی دی کاربر : <span class="item">@Model.UserId</span></p>
                                    <p>آی دی درخواست سفارش : <span class="item">@Model.OrderRequestId</span></p>
                                    <p>آی دی سفارش : <span class="item">@Model.OrderId</span></p>
                                    <p>تاریخ ثبت : <span class="item">@Model.PayDateTime</span></p>
                                    <p>وضعیت سفارش : <span class="item">@Model.OrderState</span></p>

                                    <div class="table-responsive">
                                        <table class="table table-sm mb-0 table-striped">
                                            <thead>
                                                <tr>
                                                    <th>نام محصول</th>
                                                    <th>سایز</th>
                                                    <th>قیمت</th>
                                                    <th>تعداد</th>
                                                    <th>مجموع قیمت</th>
                                                    <th></th>
                                                </tr>
                                            </thead>
                                            <tbody id="customers">
                                                @foreach (var item in Model.OrderDetails)
                                                {
                                                    <tr class="btn-reveal-trigger">
                                                        <td class="py-3">
                                                            <a href="/admin/Product/GetProductDetails?Id=@item.ProductId">
                                                                <div class="media d-flex align-items-center">
                                                                    <div class="avatar avatar-xl me-2"><div class="media d-flex align-items-center"><img class="rounded-circle img-fluid" src="~/@item.ProductImageSrc" width="30" alt=""></div></div>
                                                                    <div class="media-body"><h5 class="mb-0 fs--1">@item.ProductName</h5></div>
                                                                </div>
                                                            </a>
                                                        </td>
                                                        <td class="py-2">@item.ProductSizeName</td>
                                                        <td class="py-2">@item.ProductPrice</td>
                                                        <td class="py-2">@item.Count</td>
                                                        <td class="py-2">@((item.ProductPrice * item.Count).ToString("n0"))</td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-header d-block">
                    <h4 class="card-title">تغییر وضعیت سفارش</h4>
                </div>
                <div class="card-body">
                    @switch (Model.OrderState)
                    {
                        case OrderState.Processing:
                            <button type="button" class="btn btn-primary" onclick="ProcessingFunc('@Model.OrderId')" disabled>درحال بررسی</button>
                            <button type="button" class="btn btn-secondary" onclick="PostedFunc('@Model.OrderId')">ارسال شده</button>
                            <button type="button" class="btn btn-success" onclick="DeliveredFunc('@Model.OrderId')">تحویل داده شد</button>
                            <button type="button" class="btn btn-warning" onclick="CanceledFunc('@Model.OrderId')">لغو شده (ادمین)</button>
                            break;
                        case OrderState.Posted:
                            <button type="button" class="btn btn-primary" onclick="ProcessingFunc('@Model.OrderId')">درحال بررسی</button>
                            <button type="button" class="btn btn-secondary" onclick="PostedFunc('@Model.OrderId')" disabled>ارسال شده</button>
                            <button type="button" class="btn btn-success" onclick="DeliveredFunc('@Model.OrderId')">تحویل داده شد</button>
                            <button type="button" class="btn btn-warning" onclick="CanceledFunc('@Model.OrderId')">لغو شده (ادمین)</button>
                            break;
                        case OrderState.Delivered:
                            <button type="button" class="btn btn-primary" onclick="ProcessingFunc('@Model.OrderId')">درحال بررسی</button>
                            <button type="button" class="btn btn-secondary" onclick="PostedFunc('@Model.OrderId')">ارسال شده</button>
                            <button type="button" class="btn btn-success" onclick="DeliveredFunc('@Model.OrderId')" disabled>تحویل داده شد</button>
                            <button type="button" class="btn btn-warning" onclick="CanceledFunc('@Model.OrderId')">لغو شده (ادمین)</button>
                            break;
                        case OrderState.AdminCanceled:
                            <button type="button" class="btn btn-primary" onclick="ProcessingFunc('@Model.OrderId')">درحال بررسی</button>
                            <button type="button" class="btn btn-secondary" onclick="PostedFunc('@Model.OrderId')">ارسال شده</button>
                            <button type="button" class="btn btn-success" onclick="DeliveredFunc('@Model.OrderId')">تحویل داده شد</button>
                            <button type="button" class="btn btn-warning" onclick="CanceledFunc('@Model.OrderId')" disabled>لغو شده (ادمین)</button>
                            break;
                        default:
                            break;
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts{
    <link href="~/sweetalert2/sweetalert2.min.css" rel="stylesheet" />
    <script src="~/sweetalert2/sweetalert2.min.js"></script>

    <script>
        function ProcessingFunc(orderId){
            Swal.fire({ title: 'تغییر وضعیت سفارش',
                        text: "آیا میخواهید وضعیت سفارش را به در حال بررسی تغییر دهید؟",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#7cacbe',
                        cancelButtonColor: '#d33',
                        confirmButtonText: 'بله',
                        cancelButtonText: 'خیر'
            }).then((result) => {
                if (result.value) {

                    var OrderState = '@OrderState.Processing';
                    var OrderId = orderId;
                    var postData = {
                        'OrderId': OrderId,
                        'OrderState': OrderState,
                    };
                    $.ajax({
                        contentType: 'application/x-www-form-urlencoded',
                        dataType: 'json',
                        type: "PATCH",
                        url: "ChangeOrderState",
                        data: postData,
                        success: function (data) {
                            if (data.isSuccess == true) {
                                swal.fire(
                                    'موفق!',
                                    data.message,
                                    'success'
                                ).then(function (isConfirm) {
                                    location.reload();
                                });
                            }
                            else {
                                swal.fire(
                                    'هشدار!',
                                    data.message,
                                    'warning'
                                );
                            }
                        },
                        error: function (request, status, error) {
                            alert(request.responseText);
                        }
                    });
                }
            });
        }
        function PostedFunc(orderId){
            Swal.fire({ title: 'تغییر وضعیت سفارش',
                        text: "آیا میخواهید وضعیت سفارش را به پست شده تغییر دهید؟",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#7cacbe',
                        cancelButtonColor: '#d33',
                        confirmButtonText: 'بله',
                        cancelButtonText: 'خیر'
            }).then((result) => {
                if (result.value) {

                    var OrderState = '@OrderState.Posted';
                    var OrderId = orderId;
                    var postData = {
                        'OrderId': OrderId,
                        'OrderState': OrderState,
                    };
                    $.ajax({
                        contentType: 'application/x-www-form-urlencoded',
                        dataType: 'json',
                        type: "PATCH",
                        url: "ChangeOrderState",
                        data: postData,
                        success: function (data) {
                            if (data.isSuccess == true) {
                                swal.fire(
                                    'موفق!',
                                    data.message,
                                    'success'
                                ).then(function (isConfirm) {
                                    location.reload();
                                });
                            }
                            else {
                                swal.fire(
                                    'هشدار!',
                                    data.message,
                                    'warning'
                                );
                            }
                        },
                        error: function (request, status, error) {
                            alert(request.responseText);
                        }
                    });
                }
            });
        }
        function CanceledFunc(orderId){
            Swal.fire({ title: 'تغییر وضعیت سفارش',
                        text: "آیا میخواهید وضعیت سفارش را به لغو (توسط ادمین) تغییر دهید؟",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#7cacbe',
                        cancelButtonColor: '#d33',
                        confirmButtonText: 'بله',
                        cancelButtonText: 'خیر'
            }).then((result) => {
                if (result.value) {

                    var OrderState = '@OrderState.AdminCanceled';
                    var OrderId = orderId;
                    var postData = {
                        'OrderId': OrderId,
                        'OrderState': OrderState,
                    };
                    $.ajax({
                        contentType: 'application/x-www-form-urlencoded',
                        dataType: 'json',
                        type: "PATCH",
                        url: "ChangeOrderState",
                        data: postData,
                        success: function (data) {
                            if (data.isSuccess == true) {
                                swal.fire(
                                    'موفق!',
                                    data.message,
                                    'success'
                                ).then(function (isConfirm) {
                                    location.reload();
                                });
                            }
                            else {
                                swal.fire(
                                    'هشدار!',
                                    data.message,
                                    'warning'
                                );
                            }
                        },
                        error: function (request, status, error) {
                            alert(request.responseText);
                        }
                    });
                }
            });
        }
        function DeliveredFunc(orderId){
            Swal.fire({ title: 'تغییر وضعیت سفارش',
                        text: "آیا میخواهید وضعیت سفارش را به تحویل داده شده تغییر دهید؟",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#7cacbe',
                        cancelButtonColor: '#d33',
                        confirmButtonText: 'بله',
                        cancelButtonText: 'خیر'
            }).then((result) => {
                if (result.value) {

                    var OrderState = '@OrderState.Delivered';
                    var OrderId = orderId;
                    var postData = {
                        'OrderId': OrderId,
                        'OrderState': OrderState,
                    };
                    $.ajax({
                        contentType: 'application/x-www-form-urlencoded',
                        dataType: 'json',
                        type: "PATCH",
                        url: "ChangeOrderState",
                        data: postData,
                        success: function (data) {
                            if (data.isSuccess == true) {
                                swal.fire(
                                    'موفق!',
                                    data.message,
                                    'success'
                                ).then(function (isConfirm) {
                                    location.reload();
                                });
                            }
                            else {
                                swal.fire(
                                    'هشدار!',
                                    data.message,
                                    'warning'
                                );
                            }
                        },
                        error: function (request, status, error) {
                            alert(request.responseText);
                        }
                    });
                }
            });
        }
    </script>
}
@section Modals{

}
