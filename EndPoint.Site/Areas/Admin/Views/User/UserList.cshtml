@using Newtonsoft.Json
@using Practice_Store.Application.Services.Users.Queries.GetUsers
@using EndPoint.Site.Utilities
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@addTagHelper *, LazZiya.TagHelpers
@model ResultGetUsersDTO;
@{
    ViewData["Title"] = "Index";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
    int CheckBoxCount = 1;
    string Roles = "";
}
<div class="container-fluid">
    <div class="row page-titles">
        <ol class="breadcrumb">
            <li class="breadcrumb-item active"><a href="javascript:void(0)">مدیریت کاربران</a></li>
            <li class="breadcrumb-item"><a href="javascript:void(0)">لیست کاربران</a></li>
        </ol>
    </div>
    <div class="row">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-body">
                    <form method="get" class="input-group search-area">
                        <input type="text" class="form-control" id="srch" name="searchKey" placeholder="بین کاربران جست و جو کنید">
                        <button class="input-group-text"><i class="flaticon-381-search-2"></i></button>
                    </form>
                    @if(Model.UsersDtos.Count != 0)
                    {
                        <div class="table-responsive">
                            <table class="table table-sm mb-0 table-striped">
                                <thead>
                                    <tr>
                                        <th>نام و نام خانوادگی</th>
                                        <th>پست الکترونیک</th>
                                        <th class=" ps-5" style="min-width: 200px;">آدرس</th>
                                        <th>کد پستی</th>
                                        <th>تلفن</th>
                                        <th>وضعیت</th>
                                        <th>نقش</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="customers">
                                    @foreach (var item in Model.UsersDtos)
                                    {
                                        if (item.Mobile == "")
                                        {
                                            item.Mobile = null;
                                        }
                                        if (item.PostCode == 0)
                                        {
                                            item.PostCode = null;
                                        }
                                        @if (!item.Roles.Any(p => p.EndsWith("Admin")) || ClaimUtility.GetRoles(User).Where(p => p.Equals("Admin")).Count() >= 1)
                                        {
                                            <tr class="btn-reveal-trigger">
                                                <td class="py-3">
                                                    <a href="#">
                                                        <div class="media d-flex align-items-center">
                                                            <div class="avatar avatar-xl me-2"><div class=""><img class="rounded-circle img-fluid" src="./images/avatar/5.png" width="30" alt=""></div></div>
                                                            <div class="media-body"><h5 class="mb-0 fs--1">@item.Name @item.LastName </h5></div>
                                                        </div>
                                                    </a>
                                                </td>
                                                <td class="py-2"><a href="mailto:ricky@example.com">@item.Email</a></td>
                                                <td class="py-2 ps-5">@item.Address</td>
                                                <td class="py-2">@item.PostCode</td>
                                                <td class="py-2">@item.Mobile</td>
                                                <td class="py-2">@item.IsActive</td>
                                                <td class="py-2" id="RoleTd">@foreach (var role in item.Roles) { Roles += role + " "; }@Roles@{
                                                        Roles = "";
                                                    }</td>
                                                <td class="py-2 text-end">
                                                    <div class="dropdown">
                                                        <button class="btn btn-primary tp-btn-light sharp" type="button" data-bs-toggle="dropdown"><span class="fs--1"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18px" height="18px" viewBox="0 0 24 24" version="1.1"><g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><rect x="0" y="0" width="24" height="24"></rect><circle fill="#000000" cx="5" cy="12" r="2"></circle><circle fill="#000000" cx="12" cy="12" r="2"></circle><circle fill="#000000" cx="19" cy="12" r="2"></circle></g></svg></span></button><div class="dropdown-menu dropdown-menu-end border py-0">
                                                            <div class="py-2">
                                                                <button class="dropdown-item" onclick="ShowEditUserModalFunc('@item.Id', '@item.Name', '@item.LastName', '@item.Email', '@item.Address', '@item.PostCode', '@item.Mobile')">
                                                                    ویرایش
                                                                </button>
                                                                @if (item.IsActive == "فعال")
                                                                {
                                                                    <button class="dropdown-item" onclick="ActivationUserFunc('@item.Id')">غیرفعال سازی</button>
                                                                }
                                                                else
                                                                {
                                                                    <button class="dropdown-item" onclick="ActivationUserFunc('@item.Id')">فعال سازی</button>
                                                                }
                                                                @if (ClaimUtility.GetRoles(User).Where(p => p.Equals("Admin")).Count() >= 1)
                                                                {
                                                                    var userRolesJson = JsonConvert.SerializeObject(item.Roles).Replace("\"", "\\\"");
                                                                    <button class="dropdown-item" onclick="ShowEditRoleModalFunc('@item.Id', '@userRolesJson')">ویرایش نقش</button>
                                                                }
                                                                <button class="dropdown-item text-danger" onclick="DeleteUserFunc('@item.Id')">حذف</button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </td>
                                            </tr>
                                        }
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>
@if (Model.UsersDtos.Count == 0)
{
    <div class="col-lg-12">
        <div class="alert alert-danger left-icon-big alert-dismissible fade show">
            <div class="media">
                <div class="alert-left-icon-big"><span><i class="mdi mdi-alert"></i></span></div>
                <div class="media-body">
                    <h5 class="mt-1 mb-2">کاربری یافت نشد!</h5>
                    <p class="mb-0">مجدد جست و جو کنید</p>
                </div>
            </div>
        </div>
    </div>
}
<div class="text-center">
    <paging total-records="Model.RowsCount"
    page-no="Model.CurrentPage"
    page-size="Model.PageSize"
    max-displayed-pages="Convert.ToInt16(Model.RowsCount/Model.PageSize)+1"
    show-first-last="true"
    show-prev-next="true"
    show-total-pages="false"
    show-total-records="false"
    show-page-size-nav="false"
    show-gap="true"
    query-string-key-page-no="Page"
    query-string-key-page-size="PageSize">
    </paging>
</div>

@section Scripts
{
    <link href="~/sweetalert2/sweetalert2.min.css" rel="stylesheet" />
    <script src="~/sweetalert2/sweetalert2.min.js"></script>
    <script>
        function DeleteUserFunc(UserId) {
        swal.fire({
        title: 'حذف کاربر',
        text: "کاربر گرامی از حذف کاربر مطمئن هستید؟",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#7cacbe',
        confirmButtonText: 'بله ، کاربر حذف شود',
        cancelButtonText: 'خیر'
        }).then((result) => {
        if (result.value) {
        var postData = {
        'UserId': UserId,
        };
        $.ajax({
        contentType: 'application/x-www-form-urlencoded',
        dataType: 'json',
        type: "PATCH",
        url: "/admin/User/DeleteUser",
        data: postData,
        success: function (data) {
        if (data.isSuccess == true) {
        swal.fire(
        'موفق!',
        data.message,
        'success'
        ).then(function (isConfirm) {
        location.reload();
        });
        }
        else {
        swal.fire(
        'هشدار!',
        data.message,
        'warning'
        );
        }
        },
        error: function (request, status, error) {
        alert(request.responseText);
        }
        });
        }
        })
        }
        function ActivationUserFunc(UserId) {
        swal.fire({
        title: 'تغییر وضعیت کاربر',
        text: "کاربر گرامی از تغییر وضعیت کاربر مطمئن هستید؟",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#7cacbe',
        confirmButtonText: 'بله ، کاربر تغییر وضعیت انجام شود',
        cancelButtonText: 'خیر'
        }).then((result) => {
        if (result.value) {
        var postData = {
        'UserId': UserId,
        };
        $.ajax({
        contentType: 'application/x-www-form-urlencoded',
        dataType: 'json',
        type: "PATCH",
        url: "/admin/User/ActivationUser",
        data: postData,
        success: function (data) {
        if (data.isSuccess == true) {
        swal.fire(
        'موفق!',
        data.message,
        'success'
        ).then(function (isConfirm) {
        location.reload();
        });
        }
        else {
        swal.fire(
        'هشدار!',
        data.message,
        'warning'
        );
        }
        },
        error: function (request, status, error) {
        alert(request.responseText);
        }
        });
        }
        })
        }
        function EditUserFunc() {
        var UserId = $('#Edit_UserId').val();
        var Name = $('#Edit_Name').val();
        var LastName = $('#Edit_LastName').val();
        var Email = $('#Edit_Email').val();
        var Address = $('#Edit_Address').val();
        var PostCode = $('#Edit_PostCode').val();
        var Mobile = $('#Edit_Mobile').val();
        var Password = $('#Edit_Password').val();

        var postData = {
        'UserId': UserId,
        'Name': Name,
        'LastName': LastName,
        'Email': Email,
        'Address': Address,
        'PostCode': PostCode,
        'Mobile': Mobile,
        'Password': Password,
        };
        $.ajax({
        contentType: 'application/x-www-form-urlencoded',
        dataType: 'json',
        type: "PUT",
        url: "/admin/User/EditUser",
        data: postData,
        success: function (data) {
        if (data.isSuccess == true) {
        swal.fire(
        'موفق!',
        data.message,
        'success'
        ).then(function (isConfirm) {
        location.reload();
        });
        }
        else {
        swal.fire(
        'هشدار!',
        data.message,
        'warning'
        );
        }
        },
        error: function (request, status, error) {
        alert(request.responseText);
        }
        });
        }

        function ShowEditUserModalFunc(UserId, Name, LastName, Email, Address, POstCode, Mobile) {
        $('#Edit_UserId').val(UserId)
        $('#Edit_Name').val(Name)
        $('#Edit_LastName').val(LastName)
        $('#Edit_Email').val(Email)
        $('#Edit_Address').val(Address)
        $('#Edit_PostCode').val(POstCode)
        $('#Edit_Mobile').val(Mobile)
        $('#EditUser').modal('show');
        }

        function CloseEditUserModalFunc() {
        $('#EditUser').modal('hide');
        }

        function ShowEditRoleModalFunc(UserId, RoleIdsJson) {
        $('#EditRole_UserId').val(UserId);
        var RoleIds = JSON.parse(RoleIdsJson);
        $('input[type=checkbox]').each(function() { 
            var checkbox = $(this); 
            var roleId = checkbox.val(); 
            var roleExists = RoleIds.some(function(role) { 
                return role.RoleId == roleId; 
            }); 
            checkbox.prop('checked', roleExists); 
        });
        $('#EditRole').modal('show');
        }

        function EditUserRoleFunc(){
            var UserId = $('#EditRole_UserId').val();
            var roles = []; 
            $('input[type=checkbox]').each(function() { 
                var checkbox = $(this); 
                roles.push({
                    RoleId: checkbox.val(),
                    CheckRole: checkbox.prop('checked')
                }); 
            });
            var postData = {
        'UserId': UserId,
        'UserRoleDto': roles,
        };
        $.ajax({
        contentType: 'application/x-www-form-urlencoded',
        dataType: 'json',
        type: "PATCH",
        url: "/admin/User/EditUserRole",
        data: postData,
        success: function (data) {
        if (data.isSuccess == true) {
        swal.fire(
        'موفق!',
        data.message,
        'success'
        ).then(function (isConfirm) {
        location.reload();
        });
        }
        else {
        swal.fire(
        'هشدار!',
        data.message,
        'warning'
        );
        }
        },
        error: function (request, status, error) {
        alert(request.responseText);
        }
        });
        }

        function CloseEditUserRoleFunc(){
            $('#EditRole').modal('hide');
        }
    </script>
}
@section Modals
{
    <div class="modal fade" id="EditUser" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLongTitle">ویرایش کاربر</h5>
                </div>
                <div class="modal-body">
                    <div class="col-xl-12 col-lg-12 col-md-12 mb-1">
                        <fieldset class="form-group">
                            <input type="hidden" id="Edit_UserId" />
                            <label for="basicInput">نام</label>
                            <input type="text" class="form-control" id="Edit_Name">
                            <label for="basicInput">نام خانوادگی</label>
                            <input type="text" class="form-control" id="Edit_LastName">
                            <label for="basicInput">پست الکترونیک</label>
                            <input type="text" class="form-control" id="Edit_Email">
                            <label for="basicInput">آدرس</label>
                            <input type="text" class="form-control" id="Edit_Address">
                            <label for="basicInput">کدپستی</label>
                            <input type="text" class="form-control" id="Edit_PostCode">
                            <label for="basicInput">تلفن</label>
                            <input type="text" class="form-control" id="Edit_Mobile">
                            <label for="basicInput">رمزعبور</label>
                            <input type="password" class="form-control" id="Edit_Password">
                        </fieldset>
                    </div>
                </div>
                <div class="modal-footer">
                    <a class="btn btn-secondary" onclick="CloseEditUserModalFunc()">انصراف</a>
                    <a class="btn btn-primary" onclick="EditUserFunc()">اعمال تغییرات</a>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="EditRole" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLongTitle">ویرایش کاربر</h5>
                </div>
                <div class="modal-body">
                    <div class="col-xl-12 col-lg-12 col-md-12 mb-1">
                        <fieldset class="form-group">
                            <input type="hidden" id="EditRole_UserId" />
                            @foreach (var item in ViewBag.Roles)
                            {
                                <input type="checkbox" id="checkbox@(CheckBoxCount)" value="@item.Value">
                                <label for="checkbox@(CheckBoxCount)">@item.Text</label>
                                <br>
                                CheckBoxCount++;
                            }
                        </fieldset>
                    </div>
                </div>
                <div class="modal-footer">
                    <a class="btn btn-secondary" onclick="CloseEditUserRoleFunc()">انصراف</a>
                    <a class="btn btn-primary" onclick="EditUserRoleFunc()">اعمال تغییرات</a>
                </div>
            </div>
        </div>
    </div>
}